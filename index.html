<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>متتبع اللياقة (خطة جديدة)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --primary-color-darker: #2980b9;
      --primary-color-light: #eaf5fc;
      --completed-color: #2ecc71;
      --completed-color-glow: hsla(145, 63%, 49%, 0.5);
      --danger-color: #e74c3c;
      --note-bg-light: #fef9e7;
      --note-border-light: #f1c40f;
      --note-bg-dark: #2c3344;
      --note-border-dark: #f1c40f;
      --font-family: 'Tajawal', sans-serif;
      
      --bg-color-light: #f4f6f9;
      --surface-color-light: #ffffff;
      --on-surface-color-light: #212529;
      --on-surface-variant-light: #6c757d;
      --border-color-light: #e9ecef;
      --shadow-color-light: rgba(0, 0, 0, 0.05);
      --completed-bg-light: #eafaf1;

      --bg-color-dark: #1a1a1a;
      --surface-color-dark: #2c2c2c;
      --on-surface-color-dark: #f8f9fa;
      --on-surface-variant-dark: #adb5bd;
      --border-color-dark: #3e3e3e;
      --shadow-color-dark: rgba(0, 0, 0, 0.15);
      --completed-bg-dark: #1f3e2e;
    }

    html {
      --bg-color: var(--bg-color-light);
      --surface-color: var(--surface-color-light);
      --on-surface-color: var(--on-surface-color-light);
      --on-surface-variant: var(--on-surface-variant-light);
      --border-color: var(--border-color-light);
      --shadow-color: var(--shadow-color-light);
      --completed-bg: var(--completed-bg-light);
      --note-bg: var(--note-bg-light);
      --note-border: var(--note-border-light);
    }
    html.dark {
      --bg-color: var(--bg-color-dark);
      --surface-color: var(--surface-color-dark);
      --on-surface-color: var(--on-surface-color-dark);
      --on-surface-variant: var(--on-surface-variant-dark);
      --border-color: var(--border-color-dark);
      --shadow-color: var(--shadow-color-dark);
      --completed-bg: var(--completed-bg-dark);
      --note-bg: var(--note-bg-dark);
      --note-border: var(--note-border-dark);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--on-surface-color);
      transition: background-color 0.3s, color 0.3s;
      margin: 0;
      padding: 0;
    }
    
    .container { max-width: 800px; margin: 0 auto; padding: 20px 15px 50px 15px; }

    @keyframes fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .main-header, .selectors-container, .card, .day-content > div, .weight-chart-container, .motivational-quote {
        animation: fade-in 0.4s ease-out forwards;
        opacity: 0;
    }
    .main-header { animation-delay: 0.1s; }
    .selectors-container { animation-delay: 0.2s; }
    .motivational-quote { animation-delay: 0.25s; }

    .main-header { position: relative; padding-top: 10px; margin-bottom: 25px; }
    .theme-switcher {
        position: absolute; top: 0; left: 0; z-index: 10;
        cursor: pointer; font-size: 1.4rem; width: 44px; height: 44px;
        display: flex; align-items: center; justify-content: center;
        color: var(--on-surface-variant); background: var(--surface-color); border: 1px solid var(--border-color);
        border-radius: 50%; box-shadow: 0 2px 8px var(--shadow-color);
    }
    .theme-switcher .ph-sun { display: none; }
    html.dark .theme-switcher .ph-sun { display: block; }
    html.dark .theme-switcher .ph-moon { display: none; }

    .weight-display-card {
        display: flex; justify-content: space-between; align-items: center;
        width: 100%; background: linear-gradient(to left, var(--primary-color-darker), var(--primary-color));
        color: white; padding: 20px 25px; border-radius: 18px;
        box-shadow: 0 8px 25px -5px rgba(52, 152, 219, 0.4);
    }
    .weight-card-main { display: flex; align-items: baseline; gap: 8px; }
    .weight-display-card .value { font-size: 3rem; font-weight: 800; line-height: 1; }
    .weight-display-card .unit { font-size: 1.2rem; font-weight: 500; }
    .weight-card-label { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; opacity: 0.9; }
    .weight-card-label i { font-size: 1.8rem; }

    .selectors-container {
        background: var(--surface-color); padding: 15px; margin: 25px 0;
        border-radius: 18px; box-shadow: 0 4px 12px var(--shadow-color);
    }
    .week-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
    .week-btn {
        border: none; background: var(--bg-color); color: var(--on-surface-variant); padding: 12px 5px;
        border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-weight: 700;
        font-size: 0.9rem;
    }
    .week-btn.active {
        background: var(--primary-color); color: white;
        box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); transform: translateY(-2px);
    }
    .day-selector {
        display: flex; overflow-x: auto; padding: 5px 0 15px 0;
        margin-bottom: -15px; -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .day-selector::-webkit-scrollbar { display: none; }
    
    .day-btn {
        flex: 0 0 auto; min-width: 75px; padding: 10px; margin-left: 8px;
        border: 1px solid var(--border-color); background: var(--surface-color);
        color: var(--on-surface-variant); border-radius: 12px; cursor: pointer;
        transition: all 0.2s ease; font-size: 0.9rem; font-weight: 600; text-align: center;
        position: relative;
    }
    .day-btn:first-child { margin-right: 0; }
    .day-btn .day-name::after {
        content: ' '; font-size: 0.7em; margin-right: 4px;
        color: var(--completed-color); transition: all 0.3s ease;
    }
    .day-btn.day-fully-completed .day-name::after { content: '⭐'; }
    .day-btn .day-name { font-weight: 700; }
    .day-btn .day-progress {
        width: 100%; height: 4px; border-radius: 2px;
        background-color: var(--border-color); margin-top: 8px; overflow: hidden;
    }
    .day-btn .day-progress-bar {
        width: 0; height: 100%; background-color: var(--completed-color);
        transition: width 0.4s ease;
    }
    .day-btn.active {
        background: var(--primary-color-light); color: var(--primary-color);
        border-color: var(--primary-color);
    }
    .day-btn.day-fully-completed {
        background-color: var(--completed-bg); border: 1px solid var(--completed-color);
        color: var(--completed-color); box-shadow: 0 0 12px var(--completed-color-glow);
        transform: translateY(-2px);
    }

    .day-content { animation: fade-in 0.3s ease; }
    .motivational-quote {
        text-align: center; color: var(--primary-color); background-color: var(--primary-color-light);
        margin: 0 0 25px 0; font-size: 1.1rem; font-weight: 700; padding: 12px; border-radius: 12px;
    }
    html.dark .motivational-quote {
        background-color: var(--surface-color-dark); border: 1px solid var(--border-color-dark);
        border-right: 4px solid var(--primary-color); text-align: right; padding-right: 15px;
    }

    .section-title { font-size: 1.3rem; font-weight: 700; margin: 30px 0 15px; display: flex; align-items: center; gap: 10px; }
    .section-title i { color: var(--primary-color); font-size: 1.4rem; }

    .card {
        background: var(--surface-color); border-radius: 15px; padding: 18px;
        margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
        border: 1px solid var(--border-color); transition: all 0.2s;
    }
    .card.completed {
        background-color: var(--completed-bg);
        border-color: var(--completed-color);
    }
    .card.completed label span { text-decoration: line-through; color: var(--on-surface-variant); }
    .card label { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
    .card label span { font-weight: 500; font-size: 1rem; }
    .card input[type="checkbox"] {
        margin-left: 15px; width: 22px; height: 22px; cursor: pointer; flex-shrink: 0; appearance: none;
        border-radius: 6px; background: var(--bg-color); border: 1px solid var(--border-color);
        position: relative; transition: all 0.2s ease;
    }
    .card input[type="checkbox"]:checked { background: var(--primary-color); border-color: var(--primary-color); }
    .card input[type="checkbox"]:checked::before {
        content: ''; position: absolute; top: 5px; left: 3px; width: 12px; height: 6px;
        border: 2px solid white; border-top: none; border-right: none; transform: rotate(-45deg);
    }

    .workout-link {
        margin-right: auto; padding-right: 10px; color: var(--danger-color);
        font-size: 1.5rem; text-decoration: none; opacity: 0.7; transition: opacity 0.2s;
    }
    .workout-link:hover { opacity: 1; }
    
    .weight-input-container {
        display: flex; align-items: center; gap: 5px;
        color: var(--on-surface-variant); font-size: 0.9rem; margin-right: 10px;
    }
    .workout-weight-input {
        width: 60px; padding: 6px; border: 1px solid var(--border-color);
        border-radius: 8px; background-color: var(--bg-color); color: var(--on-surface-color);
        text-align: center; font-weight: 700; -moz-appearance: textfield;
    }
    .workout-weight-input::-webkit-outer-spin-button, .workout-weight-input::-webkit-inner-spin-button {
        -webkit-appearance: none; margin: 0;
    }
    
    .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px; }
    .option-btn {
        border: 1px solid var(--border-color); background: var(--surface-color); color: var(--on-surface-color);
        font-weight: 600; padding: 12px 0; border-radius: 12px; cursor: pointer; transition: all 0.2s;
    }
    .option-btn:active { transform: scale(0.95); }
    .option-btn.reset-btn { color: var(--danger-color); }

    .water-progress { background: var(--bg-color); height: 25px; border-radius: 12.5px; overflow: hidden; position: relative; border: 1px solid var(--border-color); }
    .water-fill { height: 100%; background: var(--primary-color); width: 0%; border-radius: 12.5px; transition: width 0.5s ease; }
    .water-progress.completed .water-fill { background: var(--completed-color); }
    .water-text { position: absolute; width: 100%; text-align: center; line-height: 25px; color: var(--on-surface-variant); font-weight: 600; font-size: 0.8rem; }
    .water-progress.completed .water-text { color: white; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }

    .input-area {
        display: flex; align-items: center; background: var(--surface-color); border: 1px solid var(--border-color);
        border-radius: 15px; padding: 8px 15px; margin-top: 15px;
    }
    .input-area:focus-within { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-color-light); }
    .input-area i { color: var(--on-surface-variant); font-size: 1.5rem; margin-left: 10px; }
    .input-area input { flex-grow: 1; border: none; background: none; padding: 8px 0; color: var(--on-surface-color); font-size: 1rem; width: 100%; }
    .input-area input:focus { outline: none; }
    
    .goals-container {
        display: flex; gap: 20px; margin: 0 5px 15px 5px; padding: 10px 0;
        justify-content: center; flex-wrap: wrap;
    }
    .goal-item {
        display: flex; align-items: center; gap: 8px;
        color: var(--on-surface-variant); font-size: 0.9rem; font-weight: 500;
    }
    .goal-item i { color: var(--on-surface-variant); font-size: 1.4rem; opacity: 0.8; }

    /* NEW: Workout Note Style */
    .workout-note-card {
        background-color: var(--note-bg);
        border-right: 4px solid var(--note-border);
        color: var(--on-surface-variant);
        padding: 12px 15px;
        border-radius: 8px;
        margin: -5px 0 15px 0;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .workout-note-card i { color: var(--note-border); font-size: 1.3rem; }

    .weight-chart-container { background: var(--surface-color); border-radius: 18px; padding: 20px; margin-top: 30px; box-shadow: 0 4px 12px var(--shadow-color); }
    .weight-chart-container .line { fill: none; stroke: var(--primary-color); stroke-width: 2.5; transition: stroke-dashoffset 2s cubic-bezier(0.47, 0, 0.745, 0.715); }
    .weight-chart-container .point { fill: var(--primary-color); stroke: var(--surface-color); stroke-width: 2; }
    .weight-chart-container .grid { stroke: var(--border-color); }
    .weight-chart-container .label { fill: var(--on-surface-variant); font-size: 11px; }
    .weight-chart-container .no-data { text-align: center; color: var(--on-surface-variant); padding: 40px 0; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal-overlay.visible { opacity: 1; pointer-events: auto; }
    .modal-content { background: var(--surface-color); padding: 25px; border-radius: 18px; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transform: scale(0.9); transition: transform 0.3s ease; }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    .modal-content h3 { margin: 0 0 20px 0; font-size: 1.5rem; text-align: center; }
    .modal-content .form-group { margin-bottom: 15px; }
    .modal-content label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--on-surface-variant); }
    .modal-content input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--bg-color); font-size: 1rem; color: var(--on-surface-color); }
    .modal-buttons { display: flex; gap: 10px; margin-top: 25px; }
    .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .modal-btn.primary { background: var(--primary-color); color: white; }
    .modal-btn.secondary { background: var(--bg-color); color: var(--on-surface-color); border: 1px solid var(--border-color); }
  </style>
</head>
<body>

  <div class="container" id="app-container">
    <header class="main-header">
        <div id="theme-switcher" class="theme-switcher">
            <i class="ph-bold ph-moon"></i><i class="ph-bold ph-sun"></i>
        </div>
        <div class="weight-display-card">
            <div class="weight-card-label">
                <i class="ph-bold ph-scales"></i>
                <span>آخر وزن مسجل</span>
            </div>
            <div class="weight-card-main">
                <span id="currentWeightDisplay" class="value">--</span>
                <span class="unit">كجم</span>
            </div>
        </div>
    </header>

    <div class="selectors-container">
        <div class="week-selector" id="week-selector"></div>
        <div class="day-selector" id="day-selector"></div>
    </div>
    <div id="day-content-area"></div>
    
    <div class="weight-chart-container">
        <h3 class="section-title"><i class="ph-bold ph-chart-line-up"></i>تطور الوزن</h3>
        <div id="weight-chart"></div>
    </div>
  </div>
  
  <div id="settings-modal" class="modal-overlay">
      <div class="modal-content">
          <h3>الإعدادات</h3>
          <div class="form-group">
              <label for="water-goal-input">هدف الماء اليومي (مل)</label>
              <input type="text" inputmode="decimal" pattern="[0-9]*" id="water-goal-input" placeholder="مثال: 3000">
          </div>
          <div class="modal-buttons">
              <button id="modal-cancel" class="modal-btn secondary">إلغاء</button>
              <button id="modal-save" class="modal-btn primary">حفظ</button>
          </div>
      </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const WEEKS = 4;
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        const dayNamesArabic = { sunday: "الأحد", monday: "الاثنين", tuesday: "الثلاثاء", wednesday: "الأربعاء", thursday: "الخميس", friday: "الجمعة", saturday: "السبت" };
        
        const dailyQuotes = {
            sunday: "البداية القوية تصنع النهاية العظيمة.",
            monday: "كل خطوة اليوم هي إنجاز الغد.",
            tuesday: "لا تتوقف عندما تتعب، توقف عندما تنتهي.",
            wednesday: "منتصف الأسبوع، دفعة إضافية من الإصرار!",
            thursday: "قليل دائم خير من كثير منقطع.",
            friday: "استمر، فالنسخة الأفضل منك تنتظرك.",
            saturday: "الراحة جزء من القوة، استعد للأسبوع القادم."
        };

        const standardMeals = [
            "الفطور: 2 بيض + توست أسمر 40جم + خيار (350 كال)", "سناك 1: 6 حبات لوز أو زبادي قليل الدسم (100 كال)",
            "الغداء: 150 جم دجاج أو لحم + 90 جم رز أو بطاطس + خضار (600 كال)", "سناك 2: تفاحة أو خيار + قهوة سوداء (100 كال)",
            "العشاء: 120 جم تونة أو زبادي بروتين + خس + توست (400 كال)"
        ];
        const standardSupplements = [ "واي بروتين بعد التمرين (120 كال)", "ملتي فيتامين بعد الفطور", "أوميغا-3 بعد الغداء" ];

        const programData = {
          week1: {
            sunday:    { workouts: [{name:"Chest Press – 3×12"}, {name:"Pec Deck – 3×12"}, {name:"Triceps Pushdown – 3×15"}, {name:"الكارديو: مشي سريع أو جهاز Elliptical – 20 دقيقة"}]},
            monday:    { workouts: [{name:"Leg Curl – 3×12"}, {name:"Leg Extension – 3×12"}, {name:"Glute Kickback – 3×15"}, {name:"الكارديو: دراجة ثابتة – 20 دقيقة"}]},
            tuesday:   { workouts: [{name:"Lat Pulldown – 3×12"}, {name:"Seated Row – 3×12"}, {name:"Dumbbell Curl – 3×15"}, {name:"Shoulder Press – 3×12"}, {name:"الكارديو: مشي سريع – 20 دقيقة"}]},
            wednesday: { workouts: [{name:"Plank – 30 ثانية × 3"}, {name:"Russian Twist – 30"}, {name:"Leg Raises – 30"}, {name:"الكارديو: HIIT جهاز – 25 دقيقة"}]},
            thursday:  { workouts: [{name:"الكارديو: مشي 30 دقيقة أو تمرين منزلي بسيط"}]},
            friday:    { workouts: [{name:"الكارديو: مشي خفيف 20 دقيقة"}]},
            saturday:  { workouts: [{name:"الكارديو: راحة أو مشي 15 دقيقة"}]}
          },
          week2: {
            sunday:    { workouts: [{name:"Chest Press – 3×15"}, {name:"Pec Deck – 3×15"}, {name:"Triceps Pushdown – 3×15"}, {name:"الكارديو: مشي سريع أو جهاز Elliptical – 20 دقيقة"}], workoutNotes: "⏱️ قلل الراحة إلى 45 ثانية بين التمارين."},
            monday:    { workouts: [{name:"Leg Curl – 3×15"}, {name:"Leg Extension – 3×15"}, {name:"Glute Kickback – 3×15"}, {name:"الكارديو: دراجة ثابتة – 20 دقيقة"}], workoutNotes: "⏱️ قلل الراحة إلى 45 ثانية بين التمارين."},
            tuesday:   { workouts: [{name:"Lat Pulldown – 3×15"}, {name:"Seated Row – 3×15"}, {name:"Dumbbell Curl – 3×15"}, {name:"Shoulder Press – 3×15"}, {name:"الكارديو: مشي سريع – 20 دقيقة"}], workoutNotes: "⏱️ قلل الراحة إلى 45 ثانية بين التمارين."},
            wednesday: { workouts: [{name:"Plank – 30 ثانية × 3"}, {name:"Russian Twist – 30"}, {name:"Leg Raises – 30"}, {name:"الكارديو: HIIT جهاز – 25 دقيقة"}], workoutNotes: "⏱️ قلل الراحة إلى 45 ثانية بين التمارين."},
            thursday:  { workouts: [{name:"الكارديو: مشي 30 دقيقة أو تمرين منزلي بسيط"}], workoutNotes: "⏱️ قلل الراحة إلى 45 ثانية بين التمارين."},
            friday:    { workouts: [{name:"الكارديو: مشي خفيف 20 دقيقة"}], workoutNotes: "⏱️ قلل الراحة إلى 45 ثانية بين التمارين."},
            saturday:  { workouts: [{name:"الكارديو: راحة أو مشي 15 دقيقة"}], workoutNotes: "⏱️ قلل الراحة إلى 45 ثانية بين التمارين."}
          },
          week3: {
            sunday:    { workouts: [{name:"Chest Press – 4×12"}, {name:"Pec Deck – 4×12"}, {name:"Triceps Pushdown – 4×15"}, {name:"الكارديو: مشي سريع أو جهاز Elliptical – 20 دقيقة"}], workoutNotes: "⬆️ زد الوزن قليلاً. في آخر مجموعة لكل تمرين، طبق Drop Set."},
            monday:    { workouts: [{name:"Leg Curl – 4×12"}, {name:"Leg Extension – 4×12"}, {name:"Glute Kickback – 4×15"}, {name:"الكارديو: دراجة ثابتة – 20 دقيقة"}], workoutNotes: "⬆️ زد الوزن قليلاً. في آخر مجموعة لكل تمرين، طبق Drop Set."},
            tuesday:   { workouts: [{name:"Lat Pulldown – 4×12"}, {name:"Seated Row – 4×12"}, {name:"Dumbbell Curl – 4×15"}, {name:"Shoulder Press – 4×12"}, {name:"الكارديو: مشي سريع – 20 دقيقة"}], workoutNotes: "⬆️ زد الوزن قليلاً. في آخر مجموعة لكل تمرين، طبق Drop Set."},
            wednesday: { workouts: [{name:"Plank – 30 ثانية × 3"}, {name:"Russian Twist – 30"}, {name:"Leg Raises – 30"}, {name:"الكارديو: HIIT جهاز – 25 دقيقة"}], workoutNotes: "⬆️ زد الوزن قليلاً. في آخر مجموعة لكل تمرين، طبق Drop Set."},
            thursday:  { workouts: [{name:"الكارديو: مشي 30 دقيقة أو تمرين منزلي بسيط"}], workoutNotes: "⬆️ زد الوزن قليلاً. في آخر مجموعة لكل تمرين، طبق Drop Set."},
            friday:    { workouts: [{name:"الكارديو: مشي خفيف 20 دقيقة"}], workoutNotes: "⬆️ زد الوزن قليلاً. في آخر مجموعة لكل تمرين، طبق Drop Set."},
            saturday:  { workouts: [{name:"الكارديو: راحة أو مشي 15 دقيقة"}], workoutNotes: "⬆️ زد الوزن قليلاً. في آخر مجموعة لكل تمرين، طبق Drop Set."}
          },
          week4: {
            sunday:    { workouts: [{name:"Chest Press – 3×12 (سوبر سيت)"}, {name:"Pec Deck – 3×12 (سوبر سيت)"}, {name:"Triceps Pushdown – 3×15 (سوبر سيت)"}, {name:"الكارديو: كارديو مكثف – 30 دقيقة"}], workoutNotes: "🔥 راحة فقط 30 ثانية بين التمارين. نفّذ Super Sets."},
            monday:    { workouts: [{name:"Leg Curl – 3×12 (سوبر سيت)"}, {name:"Leg Extension – 3×12 (سوبر سيت)"}, {name:"Glute Kickback – 3×15 (سوبر سيت)"}, {name:"الكارديو: كارديو مكثف – 30 دقيقة"}], workoutNotes: "🔥 راحة فقط 30 ثانية بين التمارين. نفّذ Super Sets."},
            tuesday:   { workouts: [{name:"Lat Pulldown – 3×12 (سوبر سيت)"}, {name:"Seated Row – 3×12 (سوبر سيت)"}, {name:"Dumbbell Curl – 3×15 (سوبر سيت)"}, {name:"Shoulder Press – 3×12 (سوبر سيت)"}, {name:"الكارديو: كارديو مكثف – 30 دقيقة"}], workoutNotes: "🔥 راحة فقط 30 ثانية بين التمارين. نفّذ Super Sets."},
            wednesday: { workouts: [{name:"Plank – 30 ثانية × 3 (سوبر سيت)"}, {name:"Russian Twist – 30 (سوبر سيت)"}, {name:"Leg Raises – 30 (سوبر سيت)"}, {name:"الكارديو: كارديو مكثف – 30 دقيقة"}], workoutNotes: "🔥 راحة فقط 30 ثانية بين التمارين. نفّذ Super Sets."},
            thursday:  { workouts: [{name:"الكارديو: كارديو مكثف – 30 دقيقة"}], workoutNotes: "🔥 راحة فقط 30 ثانية بين التمارين. نفّذ Super Sets."},
            friday:    { workouts: [{name:"الكارديو: كارديو مكثف – 30 دقيقة"}], workoutNotes: "🔥 راحة فقط 30 ثانية بين التمارين. نفّذ Super Sets."},
            saturday:  { workouts: [{name:"الكارديو: كارديو مكثف – 30 دقيقة"}], workoutNotes: "🔥 راحة فقط 30 ثانية بين التمارين. نفّذ Super Sets."}
          }
        };

        // Populate all days with standard meals and supplements
        for (let i = 1; i <= WEEKS; i++) {
            days.forEach(day => {
                if(programData[`week${i}`][day]) {
                    programData[`week${i}`][day].meals = standardMeals;
                    programData[`week${i}`][day].supplements = standardSupplements;
                }
            });
        }
        
        const App = {
            state: { activeWeek: 'week1', activeDay: 'sunday', appData: {}, settings: { waterGoal: 3000, theme: 'light' }},
            elements: {},
            init() {
                this.elements = {
                    currentWeightDisplay: document.getElementById('currentWeightDisplay'),
                    dayContentArea: document.getElementById('day-content-area'),
                    daySelector: document.getElementById('day-selector'),
                    weekSelector: document.getElementById('week-selector'),
                    weightChart: document.getElementById('weight-chart'),
                    themeSwitcher: document.getElementById('theme-switcher'),
                    settingsModal: {
                        overlay: document.getElementById('settings-modal'),
                        waterGoalInput: document.getElementById('water-goal-input'),
                        saveBtn: document.getElementById('modal-save'),
                        cancelBtn: document.getElementById('modal-cancel')
                    }
                };
                this.loadData();
                this.applyTheme();
                this.renderSelectors();
                this.addEventListeners();
                const todayDayName = days[new Date().getDay()];
                const lastWeek = localStorage.getItem('gymTrackerApp_lastWeek_v5') || 'week1';
                this.setActiveState(lastWeek, todayDayName, true);
            },
            loadData() {
                const savedData = localStorage.getItem('gymTrackerApp_data_v5');
                this.state.appData = savedData ? JSON.parse(savedData) : {};
                const savedSettings = localStorage.getItem('gymTrackerApp_settings_v5');
                if (savedSettings) { this.state.settings = { ...this.state.settings, ...JSON.parse(savedSettings) }; }

                for (let i = 1; i <= WEEKS; i++) {
                    const weekKey = `week${i}`;
                    if (!this.state.appData[weekKey]) this.state.appData[weekKey] = {};
                    days.forEach(day => {
                        const dayProgram = programData[weekKey]?.[day] || { workouts: [], meals: [], supplements: [] };
                        const dayData = this.state.appData[weekKey][day];
                        if (!dayData || typeof dayData.workouts?.[0] === 'boolean' || !Array.isArray(dayData.supplements)) {
                            this.state.appData[weekKey][day] = {
                                workouts: Array(dayProgram.workouts.length).fill(null).map(() => ({ checked: false, weight: '' })),
                                meals: Array(dayProgram.meals.length).fill(false),
                                supplements: Array(dayProgram.supplements.length).fill(false),
                                waterHistory: dayData?.waterHistory || [],
                                weight: dayData?.weight || ''
                            };
                        }
                    });
                }
            },
            saveData() {
                localStorage.setItem('gymTrackerApp_data_v5', JSON.stringify(this.state.appData));
                localStorage.setItem('gymTrackerApp_settings_v5', JSON.stringify(this.state.settings));
                localStorage.setItem('gymTrackerApp_lastWeek_v5', this.state.activeWeek);
                this.updateLatestWeightDisplay();
                this.renderWeightChart();
            },
            applyTheme() { document.documentElement.className = this.state.settings.theme; },
            toggleTheme() {
                this.state.settings.theme = this.state.settings.theme === 'light' ? 'dark' : 'light';
                this.applyTheme(); this.saveData();
            },
            renderSelectors() {
                this.elements.weekSelector.innerHTML = Array.from({length: WEEKS}, (_, i) => `<button class="week-btn" data-week="week${i + 1}">الأسبوع ${i + 1}</button>`).join('');
                this.elements.daySelector.innerHTML = days.map(day => `<button class="day-btn" data-day="${day}"><span class="day-name">${dayNamesArabic[day]}</span><div class="day-progress"><div class="day-progress-bar"></div></div></button>`).join('');
            },
            createTaskCardHTML(type, index, task) {
                const isWorkout = type === 'workouts';
                const text = isWorkout ? task.name : task;
                const weightInputHTML = isWorkout
                    ? `<div class="weight-input-container">
                         <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" class="workout-weight-input" placeholder="--" data-index="${index}">
                         <span>كجم</span>
                       </div>`
                    : '';
                return `<div class="card" data-type="${type}" data-index="${index}"><label><input type="checkbox"/><span>${text}</span></label>${weightInputHTML}</div>`;
            },
            generateDayContentHTML(week, day) {
                const dayProgram = programData[week]?.[day]; if (!dayProgram) return '<p>لا توجد بيانات لهذا اليوم.</p>';
                const workoutsHTML = dayProgram.workouts.map((task, i) => this.createTaskCardHTML('workouts', i, task)).join('');
                const mealsHTML = dayProgram.meals.map((task, i) => this.createTaskCardHTML('meals', i, task)).join('');
                const supplementsHTML = dayProgram.supplements.map((task, i) => this.createTaskCardHTML('supplements', i, task)).join('');
                const quote = dailyQuotes[day] || '';
                let workoutNotesHTML = dayProgram.workoutNotes ? `<div class="workout-note-card"><i class="ph-bold ph-push-pin"></i><span>${dayProgram.workoutNotes}</span></div>` : '';
                let supplementsSection = (dayProgram.supplements && dayProgram.supplements.length > 0)
                    ? `<div class="section-title"><i class="ph-bold ph-pill"></i>المكملات (اختياري)</div>${supplementsHTML}` : '';

                return `<div class="day-content">
                            <p class="motivational-quote">${quote}</p>
                            <div class="section-title"><i class="ph-bold ph-barbell"></i>التمارين</div>${workoutNotesHTML}<div class="workouts-container">${workoutsHTML}</div>
                            <div class="section-title"><i class="ph-bold ph-bowl-food"></i>الوجبات</div>${mealsHTML}
                            ${supplementsSection}
                            <div class="section-title"><i class="ph-bold ph-tint"></i>شرب الماء</div>
                            <div class="options-grid">
                                <button class="option-btn" data-action="add-water" data-amount="250">+ ٢٥٠ مل</button>
                                <button class="option-btn" data-action="add-water" data-amount="500">+ ٥٠٠ مل</button>
                                <button class="option-btn" data-action="add-water" data-amount="750">+ ٧٥٠ مل</button>
                                <button class="option-btn reset-btn" data-action="undo-water"><i class="ph-bold ph-arrow-u-up-left"></i> تراجع</button>
                            </div>
                            <div class="water-progress-container"><div class="water-progress"><div class="water-text"></div><div class="water-fill"></div></div></div>
                            <div class="section-title"><i class="ph-bold ph-activity"></i>أهداف اليوم</div>
                            <div class="goals-container">
                                <div class="goal-item"><i class="ph-bold ph-drop"></i><span>الماء: 3 لتر</span></div>
                                <div class="goal-item"><i class="ph-bold ph-bed"></i><span>النوم: 7.5 - 8 ساعات</span></div>
                            </div>
                            <div class="section-title"><i class="ph-bold ph-scales"></i>تسجيل الوزن</div>
                            <div class="input-area"><i class="ph-bold ph-trend-up"></i><input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" placeholder="أدخل وزنك اليوم (كجم)..." /></div>
                        </div>`;
            },
            renderDayContent() {
                const { activeWeek, activeDay } = this.state;
                this.elements.dayContentArea.innerHTML = this.generateDayContentHTML(activeWeek, activeDay);
                this.updateUIForDay(activeWeek, activeDay);
            },
            updateUIForDay(week, day) {
                const dayData = this.state.appData[week]?.[day]; if (!dayData) return;
                const content = this.elements.dayContentArea.querySelector('.day-content'); if (!content) return;
                
                dayData.workouts.forEach((workout, i) => {
                    const card = content.querySelector(`[data-type='workouts'][data-index='${i}']`);
                    if(card) {
                        card.querySelector('input[type="checkbox"]').checked = workout.checked;
                        card.querySelector('.workout-weight-input').value = workout.weight;
                        card.classList.toggle('completed', workout.checked);
                    }
                });

                ['meals', 'supplements'].forEach(type => {
                    if (dayData[type]) {
                        dayData[type].forEach((isChecked, i) => {
                            const card = content.querySelector(`[data-type='${type}'][data-index='${i}']`);
                            if (card) {
                                card.querySelector('input[type="checkbox"]').checked = isChecked;
                                card.classList.toggle('completed', isChecked);
                            }
                        });
                    }
                });

                const totalWater = dayData.waterHistory.reduce((a, b) => a + b, 0); const waterGoal = this.state.settings.waterGoal;
                const percentage = Math.min((totalWater / waterGoal) * 100, 100);
                const waterProgress = content.querySelector('.water-progress');
                waterProgress.querySelector('.water-fill').style.width = `${percentage}%`;
                waterProgress.querySelector('.water-text').textContent = `${totalWater} / ${waterGoal} مل`;
                waterProgress.classList.toggle('completed', percentage >= 100);
                content.querySelector('.input-area input').value = dayData.weight;
                this.updateDayProgressIndicator(week, day);
            },
            updateAllDayProgressIndicators(week) { days.forEach(day => this.updateDayProgressIndicator(week, day)); },
            updateDayProgressIndicator(week, day) {
                const dayData = this.state.appData[week]?.[day]; if(!dayData) return;
                const dayProgram = programData[week]?.[day] || {workouts:[], meals:[]};
                const dayBtn = this.elements.daySelector.querySelector(`.day-btn[data-day='${day}']`); if(!dayBtn) return;
                
                const totalTasks = (dayProgram.workouts?.length || 0) + (dayProgram.meals?.length || 0);
                const completedWorkouts = dayData.workouts?.filter(w => w.checked).length || 0;
                const completedMeals = dayData.meals?.filter(Boolean).length || 0;
                const completedTasks = completedWorkouts + completedMeals;

                const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0; 
                dayBtn.querySelector('.day-progress-bar').style.width = `${progress}%`;
                const allTasksDone = totalTasks > 0 && completedTasks === totalTasks;
                const waterGoal = this.state.settings.waterGoal;
                const totalWater = dayData.waterHistory.reduce((a, b) => a + b, 0);
                const waterGoalMet = totalWater >= waterGoal;
                dayBtn.classList.toggle('day-fully-completed', allTasksDone && waterGoalMet);
            },
            updateLatestWeightDisplay() {
                let latestWeight = null, found = false;
                for (let i = WEEKS; i >= 1 && !found; i--) {
                    for (let j = days.length - 1; j >= 0 && !found; j--) {
                        const weight = this.state.appData[`week${i}`]?.[days[j]]?.weight;
                        if (weight && String(weight).trim() !== '') { latestWeight = weight; found = true; }
                    }
                }
                this.elements.currentWeightDisplay.textContent = latestWeight ? parseFloat(latestWeight).toFixed(1) : '--';
            },
            renderWeightChart() {
                const weightData = []; let dayIndex = 0;
                for (let i = 1; i <= WEEKS; i++) { days.forEach((dayKey, k) => { const weight = this.state.appData[`week${i}`]?.[dayKey]?.weight; if (weight && String(weight).trim() !== '') { weightData.push({ day: ((i-1)*7)+k, weight: parseFloat(weight) }); } }); }
                const chartEl = this.elements.weightChart; if (weightData.length < 2) { chartEl.innerHTML = '<p class="no-data">سجل وزنك ليومين على الأقل لرسم المخطط.</p>'; return; }
                const svgWidth = chartEl.clientWidth; const svgHeight = 200; const margin = { top: 20, right: 20, bottom: 30, left: 40 };
                const width = svgWidth - margin.left - margin.right; const height = svgHeight - margin.top - margin.bottom;
                const weights = weightData.map(d => d.weight); const minWeight = Math.min(...weights) - 2; const maxWeight = Math.max(...weights) + 2;
                const totalDays = WEEKS * 7;
                const xScale = (day) => margin.left + (day / (totalDays - 1)) * width; const yScale = (weight) => margin.top + height - ((weight - minWeight) / (maxWeight - minWeight)) * height;
                const linePath = weightData.map(d => `${xScale(d.day)},${yScale(d.weight)}`).join(' ');
                chartEl.innerHTML = `<svg viewBox="0 0 ${svgWidth} ${svgHeight}"><polyline class="line" points="${linePath}"></polyline>${weightData.map(d => `<circle class="point" cx="${xScale(d.day)}" cy="${yScale(d.weight)}" r="4"></circle>`).join('')}</svg>`;
            },
            addEventListeners() {
                this.elements.daySelector.parentElement.addEventListener('click', (e) => {
                    const w = e.target.closest('.week-btn'), d = e.target.closest('.day-btn');
                    if (w) this.setActiveState(w.dataset.week, this.state.activeDay);
                    if (d) this.setActiveState(this.state.activeWeek, d.dataset.day);
                });
                this.elements.dayContentArea.addEventListener('input', (e) => {
                    if (e.target.matches('input[type="checkbox"]')) this.handleCheckboxChange(e.target);
                    if (e.target.matches('.input-area input')) this.handleWeightChange(e.target);
                    if (e.target.matches('.workout-weight-input')) this.handleWorkoutWeightChange(e.target);
                });
                this.elements.dayContentArea.addEventListener('click', (e) => {
                    const btn = e.target.closest('button');
                    if (btn && btn.dataset.action) this.handleActionClick(btn);
                });
                this.elements.themeSwitcher.addEventListener('click', () => this.toggleTheme());
                this.elements.settingsModal.saveBtn.addEventListener('click', () => this.saveSettings());
                this.elements.settingsModal.cancelBtn.addEventListener('click', () => this.toggleModal(false));
                this.elements.settingsModal.overlay.addEventListener('click', (e) => { if (e.target === this.elements.settingsModal.overlay) this.toggleModal(false); });
            },
            setActiveState(week, day, force = false) {
                if (!force && this.state.activeWeek === week && this.state.activeDay === day) return;
                const weekChanged = this.state.activeWeek !== week;
                this.state.activeWeek = week; this.state.activeDay = day;
                document.querySelectorAll('.week-btn.active').forEach(b => b.classList.remove('active'));
                document.querySelector(`.week-btn[data-week="${week}"]`)?.classList.add('active');
                document.querySelectorAll('.day-btn.active').forEach(b => b.classList.remove('active'));
                const newActiveDayBtn = document.querySelector(`.day-btn[data-day="${day}"]`);
                if (newActiveDayBtn) {
                    newActiveDayBtn.classList.add('active');
                    newActiveDayBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
                if(weekChanged) this.updateAllDayProgressIndicators(week);
                this.renderDayContent();
            },
            handleActionClick(button) {
                const { activeWeek, activeDay } = this.state; const dayData = this.state.appData[activeWeek][activeDay];
                const action = button.dataset.action;
                if (action === 'add-water') { dayData.waterHistory.push(parseInt(button.dataset.amount)); }
                else if (action === 'undo-water') { dayData.waterHistory.pop(); }
                else if (action === 'open-settings') { this.toggleModal(true); }
                this.saveData(); this.updateUIForDay(activeWeek, activeDay);
            },
            handleCheckboxChange(checkbox) {
                const { activeWeek, activeDay } = this.state;
                const card = checkbox.closest('.card');
                const { type, index } = card.dataset;
                if (type === 'workouts') {
                    this.state.appData[activeWeek][activeDay].workouts[index].checked = checkbox.checked;
                } else {
                    this.state.appData[activeWeek][activeDay][type][index] = checkbox.checked;
                }
                this.saveData();
                this.updateUIForDay(activeWeek, activeDay);
            },
            handleWorkoutWeightChange(input) {
                const { activeWeek, activeDay } = this.state;
                const { index } = input.dataset;
                if (this.state.appData[activeWeek][activeDay].workouts[index]) {
                   this.state.appData[activeWeek][activeDay].workouts[index].weight = input.value;
                   this.saveData();
                }
            },
            handleWeightChange(input) {
                const { activeWeek, activeDay } = this.state;
                this.state.appData[activeWeek][activeDay].weight = input.value;
                this.saveData();
            },
            toggleModal(visible) {
                const { overlay, waterGoalInput } = this.elements.settingsModal;
                if (visible) {
                    waterGoalInput.value = this.state.settings.waterGoal;
                    overlay.classList.add('visible');
                } else { overlay.classList.remove('visible'); }
            },
            saveSettings() {
                const newGoal = parseInt(this.elements.settingsModal.waterGoalInput.value);
                if (newGoal && newGoal > 0) {
                    this.state.settings.waterGoal = newGoal;
                    this.saveData(); this.toggleModal(false);
                    this.updateUIForDay(this.state.activeWeek, this.state.activeDay);
                }
            }
        };

        App.init();
    });
  </script>
</body>
</html>